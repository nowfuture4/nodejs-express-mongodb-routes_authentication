<!DOCTYPE html>
<html>
    <head>
        <title><%= title %></title>
        <link rel="stylesheet" href="/stylesheets/style.css" />
    </head>
    <body>
        <h1>mongodb crud <button id="logout">注销</button></h1>
        <div>
            <div>用户名:<input id="username" /></div>
            <div>密码:<input type="password" id="password" /></div>
            <div>年龄:<input type="number" id="age" /></div>
            <div><button id="register">添加</button></div>
        </div>
        <div>
            <div>
                <table border="1px solid black" cellspacing="0" cellpadding="0">
                    <thead>
                        <tr>
                            <td>id</td>
                            <td>用户名</td>
                            <td>密码</td>
                            <td>年龄</td>
                        </tr>
                    </thead>
                    <tbody id="userList"></tbody>
                </table>
            </div>
        </div>
        <script>
            var register = document.querySelector("#register");
            var username = document.querySelector("#username");
            var password = document.querySelector("#password");
            var age = document.querySelector("#age");
            var userList = document.querySelector("#userList");
            var logout = document.querySelector("#logout");

            // 注册 添加add
            register.onclick = () => {
                console.log(username.value);
                fetch("/api/user/add", {
                    method: "POST",
                    body: JSON.stringify({
                        username: username.value,
                        password: password.value,
                        age: age.value,
                    }),
                    headers: {
                        "Content-type": "application/json",
                    },
                })
                    .then((res) => res.json())
                    .then((res) => {
                        console.log(res);
                        if (res.ok === 0) {
                            location.href = "/login";
                        }
                    });
            };

            // 获取userList
            fetch("/api/user/list")
                .then((res) => res.json())
                .then((res) => {
                    console.log(res);
                    if (res.ok === 0) {
                        location.href = "/login";
                    }
                    render(res);
                });

            // TODO: 对获取的数据进行渲染
            function render(data) {
                userList.innerHTML = data
                    .map(
                        (item) =>
                            `<tbody><tr><td>${item._id}</td><td>${item.username}</td><td>${item.password}</td><td>${item.age}</td><td>更新</td><td>删除</td></tr></tbody>`
                    )
                    .join("");
            }

            // logout注销
            logout.onclick=()=>{
                fetch("/api/logout")
                    .then((res) => res.json())
                    .then((res) => {
                        console.log(res);
                        if (res.ok === 1) {
                            location.href = "/login";
                        }
                    });
            }
        </script>
    </body>
</html>
